# 性能监控工具使用指南

## 📊 analyze_cycle_time.py - 处理周期分析工具

这个工具可以分析Render日志，自动计算处理周期耗时、跳过次数、AI处理性能等关键指标。

---

## 🚀 使用方法

### 方法1: 从Render Dashboard复制日志（推荐）

1. **访问Render Dashboard**
   - 打开 https://dashboard.render.com/
   - 进入 AI Service
   - 点击 "Logs" 标签

2. **复制日志内容**
   - 向下滚动查看最近的日志
   - 全选并复制（建议复制最近500-1000行）
   - Cmd+A (全选) → Cmd+C (复制)

3. **保存为文件**
   ```bash
   # 在本地项目目录
   nano render_logs.txt
   # 粘贴日志内容
   # Ctrl+O 保存, Ctrl+X 退出
   ```

4. **运行分析**
   ```bash
   cd /Users/xufan3/news-brief-platform
   python scripts/analyze_cycle_time.py render_logs.txt
   ```

---

### 方法2: 交互式输入

```bash
cd /Users/xufan3/news-brief-platform
python scripts/analyze_cycle_time.py
# 粘贴日志内容
# 按 Ctrl+D 结束输入
```

---

### 方法3: 从Render Shell直接分析（如果有SSH访问）

```bash
# 在Render Shell中
cd /opt/render/project/src
tail -1000 /var/log/*.log | python scripts/analyze_cycle_time.py
```

---

## 📈 输出示例

```
============================================================
新闻处理周期性能分析报告
============================================================

📊 处理周期耗时统计
------------------------------------------------------------
样本数量: 8次
平均耗时: 10.3分钟 (618秒)
最快一次: 9.2分钟 (551秒)
最慢一次: 11.5分钟 (692秒)

最近10次耗时:
  #1: 10.1分钟 (608秒) ⚠️  过慢
  #2: 10.5分钟 (628秒) ⚠️  过慢
  #3: 9.8分钟 (590秒) ⚡ 可优化
  #4: 10.9分钟 (652秒) ⚠️  过慢
  #5: 9.2分钟 (551秒) ⚡ 可优化
  #6: 11.2分钟 (670秒) ⚠️  过慢
  #7: 10.0分钟 (602秒) ⚠️  过慢
  #8: 11.5分钟 (692秒) ⚠️  过慢

⏱️  性能评估:
  🔴 Critical - 平均耗时>10分钟，建议将CRAWL_INTERVAL设为900秒(15分钟)

🚫 调度跳过统计
------------------------------------------------------------
跳过次数: 35次
跳过比例: 4.4次/完成周期
  🔴 严重 - 每次完成前平均跳过>3次，间隔严重过短

🤖 AI处理统计
------------------------------------------------------------
平均处理数量: 54条/次
最多一次: 62条
最少一次: 48条
估算AI单条耗时: 9.2秒/条
  🟡 Warning - 单条耗时>8秒，建议考虑并发处理或限制数量

💡 优化建议
------------------------------------------------------------
1. 🔴 立即执行:
   - 将CRAWL_INTERVAL改为900秒(15分钟)
   - 在Render Dashboard → Environment → CRAWL_INTERVAL=900

2. 🟡 后续优化:
   - 实现AI并发处理（ThreadPoolExecutor）
   - 或限制每次最多处理30条新闻
   - 移除失效的RSS源

============================================================
```

---

## 🎯 关键指标说明

### 平均耗时
- **< 3分钟**: 🟢 Excellent - 性能优秀
- **3-5分钟**: 🟢 Good - 性能良好
- **5-10分钟**: 🟡 Warning - 需要优化
- **> 10分钟**: 🔴 Critical - 严重过慢

### 跳过比例
- **< 1次/周期**: 🟢 正常 - 偶尔跳过
- **1-3次/周期**: 🟡 警告 - 间隔偏短
- **> 3次/周期**: 🔴 严重 - 间隔严重过短

### AI单条耗时
- **< 5秒**: 🟢 Good - DeepSeek响应快
- **5-8秒**: 🟢 Normal - 正常范围
- **8-15秒**: 🟡 Warning - 可能限流或网络慢
- **> 15秒**: 🔴 Critical - 严重过慢

---

## 🔧 基于分析结果的操作建议

### 场景1: 平均耗时 > 10分钟

**立即执行**:
1. 访问 Render Dashboard
2. AI Service → Environment
3. 添加/修改: `CRAWL_INTERVAL=900`
4. 保存（自动重新部署）

**等待5-10分钟部署完成**

**预期效果**:
- 不再有"跳过调度"警告
- 系统稳定运行
- 新闻每15分钟更新一次

---

### 场景2: AI单条耗时 > 8秒

**短期方案**: 限制处理数量
```python
# 在 cloud_ai_processor.py 的 batch_process 开头添加
MAX_PROCESS_COUNT = 30

if len(news_list) > MAX_PROCESS_COUNT:
    logger.info(f"新闻数量({len(news_list)})超过限制，仅处理前{MAX_PROCESS_COUNT}条")
    news_list = news_list[:MAX_PROCESS_COUNT]
```

**长期方案**: 实现并发处理
- 参考 docs/PERFORMANCE_MONITORING.md 的"优化方案B"

---

### 场景3: 跳过比例 > 3

说明 CRAWL_INTERVAL 设置太短，建议调整为：
- 当前平均耗时 × 1.5

例如：
- 平均10分钟 → 设为900秒(15分钟)
- 平均5分钟 → 设为450秒(7.5分钟)

---

## 📋 定期监控建议

### 每日检查（前3天）
1. 运行分析工具检查耗时趋势
2. 观察跳过次数是否减少
3. 验证新闻正常更新

### 每周检查
1. 分析平均耗时变化
2. 检查AI处理成功率
3. 评估是否需要进一步优化

---

## 🐛 故障排查

### 问题1: "未找到处理周期耗时数据"

**原因**: 日志内容不包含完整周期

**解决**:
- 复制更多日志内容（至少500行）
- 确保包含 "本轮采集完成，耗时" 的行

### 问题2: 分析结果异常

**原因**: 日志格式变化或版本不同

**解决**:
- 检查日志格式是否与脚本预期一致
- 联系开发者更新脚本

---

## 📞 需要帮助？

如果分析结果显示性能问题：
1. 查看 docs/PERFORMANCE_MONITORING.md 详细优化指南
2. 参考 docs/RACE_CONDITION_FIX.md 了解锁机制
3. 根据分析建议调整配置

---

**创建时间**: 2026-02-04
**工具版本**: 1.0
